# çµæœå±€é¡¯ç¤ºæ™‚åºåˆ†æ

## ç•¶å‰æµç¨‹ï¼ˆå•é¡Œç¾è±¡ï¼‰

### å ´æ™¯ï¼šå…©é–’æ‰“èŠï¼ˆPP then bet Bï¼‰

```
æ™‚é–“è»¸ï¼š
T1: ç¬¬1å€‹ P é–‹å‡º â†’ è¨˜éŒ„åˆ°æ­·å²
T2: ç¬¬2å€‹ P é–‹å‡º â†’ è¨˜éŒ„åˆ°æ­·å² âœ… æ­¤æ™‚æ­·å²å·²æ˜¯ [P, P]
T3: ç³»çµ±æª¢æ¸¬åˆ°ã€Œå¯ä¸‹æ³¨ã€ç•«é¢
T4: æ»‘é¼ ç§»å‹•åˆ°ä¸‹æ³¨ä½ç½®
T5: **æ­¤æ™‚æ‰é¡¯ç¤ºã€Œçµæœå±€ã€** âš ï¸ å¤ªæ™šäº†ï¼
```

### ç•¶å‰å¯¦ç¾çš„è©³ç´°æµç¨‹

#### éšæ®µ 1: çµæœæª¢æ¸¬ï¼ˆT2ï¼‰
```python
# engine_worker.py Line 1264
round_id = self._game_state.on_result_detected(table_id, winner="P", timestamp=T2)

# ç”¢ç”Ÿäº‹ä»¶
event = {"type": "RESULT", "winner": "P", "round_id": round_id}
self._incoming_events.put(event)
```

#### éšæ®µ 2: çµæœè™•ç†ï¼ˆT2ï¼‰
```python
# engine_worker.py Line 443
def _handle_event(event):
    if event_type == "RESULT":
        # èª¿ç”¨ handle_result æ›´æ–°æ­·å²
        self._line_orchestrator.handle_result(table_id, round_id, winner="P", timestamp=T2)
        # âœ… æ­¤æ™‚ SignalTracker.history å·²åŒ…å« [P, P]

        # âŒ ä½†é€™è£¡ä¸æª¢æŸ¥è§¸ç™¼æ¢ä»¶ï¼
        # âŒ ä¸é¡¯ç¤ºã€Œçµæœå±€ã€ï¼
```

#### éšæ®µ 3: éšæ®µè®ŠåŒ–ï¼ˆT3 - æª¢æ¸¬åˆ°å¯ä¸‹æ³¨ï¼‰
```python
# engine_worker.py Line 1039
def _on_phase_changed(table_id, round_id, phase="bettable", timestamp=T3):
    # åªæ›´æ–°éšæ®µï¼Œä¸ç”Ÿæˆæ±ºç­–
    self._line_orchestrator.update_table_phase(
        table_id, round_id, TablePhase.BETTABLE, timestamp,
        generate_decisions=False  # âŒ é€™è£¡ä¸è§¸ç™¼
    )
```

#### éšæ®µ 4: å¯ä¸‹æ³¨ç•«é¢è™•ç†ï¼ˆT3-T4ï¼‰
```python
# engine_worker.py Line 812
def on_bettable_detected():
    # æ˜ç¢ºè¦æ±‚ç”Ÿæˆæ±ºç­–
    decisions = self._line_orchestrator.update_table_phase(
        table_id, round_id, TablePhase.BETTABLE, timestamp,
        generate_decisions=True  # âœ… é€™è£¡æ‰è§¸ç™¼æª¢æŸ¥
    )

    # orchestrator.py Line 287
    if phase == TablePhase.BETTABLE and generate_decisions:
        decisions = self._evaluate_and_decide(...)

    # entry_evaluator.py Line 202
    should_trigger_result = tracker.should_trigger(table_id, round_id, timestamp)
    # âœ… æª¢æŸ¥æ­·å² [P, P] æ˜¯å¦åŒ¹é…æ¨¡å¼ "PP"
    # âœ… åŒ¹é…æˆåŠŸï¼
```

#### éšæ®µ 5: ä¸‹æ³¨åŸ·è¡Œï¼ˆT4-T5ï¼‰
```python
# engine_worker.py Line 1539
# ç™¼é€ bet_executed ä¿¡è™Ÿ
self.bet_executed.emit({
    "strategy": "å…©é–’æ‰“èŠ",
    "direction": "banker",
    "amount": 100,
    ...
})
```

#### éšæ®µ 6: UI é¡¯ç¤ºçµæœå±€ï¼ˆT5ï¼‰
```python
# page_dashboard.py
# æ”¶åˆ° bet_executed ä¿¡è™Ÿå¾Œæ‰é¡¯ç¤º
self.result_round_card.show_pending_bet(data)
```

---

## å•é¡Œåˆ†æ

### æ ¸å¿ƒå•é¡Œ
**è§¸ç™¼æª¢æŸ¥ï¼ˆshould_triggerï¼‰å»¶é²åˆ°ã€Œæª¢æ¸¬å¯ä¸‹æ³¨ç•«é¢ã€æ™‚æ‰åŸ·è¡Œ**

### æ™‚åºå°æ¯”

| äº‹ä»¶ | ç•¶å‰æ™‚é–“é» | ç†æƒ³æ™‚é–“é» | å»¶é² |
|------|----------|----------|------|
| çµæœæª¢æ¸¬ | T2 | T2 | 0 |
| æ­·å²æ›´æ–° | T2 | T2 | 0 |
| **è§¸ç™¼æª¢æŸ¥** | T4 âš ï¸ | T2 âœ… | ~2-3ç§’ |
| çµæœå±€é¡¯ç¤º | T5 âš ï¸ | T2 âœ… | ~3-5ç§’ |

### ç‚ºä»€éº¼å»¶é²ï¼Ÿ

**ç•¶å‰è¨­è¨ˆé‚è¼¯ï¼š**
```python
# çµæœè™•ç†æ™‚ï¼šåªæ›´æ–°æ­·å²ï¼Œä¸æª¢æŸ¥è§¸ç™¼
_handle_event(RESULT) â†’ handle_result() â†’ SignalTracker.record()
                                         â†’ âŒ ä¸èª¿ç”¨ should_trigger()

# å¯ä¸‹æ³¨æª¢æ¸¬æ™‚ï¼šæ‰æª¢æŸ¥è§¸ç™¼
on_bettable_detected() â†’ update_table_phase(generate_decisions=True)
                       â†’ evaluate_and_decide()
                       â†’ should_trigger() âœ…
```

**è¨­è¨ˆåŸå› ï¼š**
- åˆ†é›¢é—œæ³¨é»ï¼šçµæœè™•ç† vs æ±ºç­–ç”Ÿæˆ
- é¿å…éæ—©è§¸ç™¼ï¼ˆå¯èƒ½ç•«é¢é‚„æœªé€²å…¥å¯ä¸‹æ³¨éšæ®µï¼‰
- ç¢ºä¿æœ‰ round_id å¯ç”¨æ–¼ä¸‹æ³¨

---

## ç”¨æˆ¶æœŸæœ›è¡Œç‚º

### ç†æƒ³æµç¨‹
```
T1: ç¬¬1å€‹ P é–‹å‡º â†’ è¨˜éŒ„
T2: ç¬¬2å€‹ P é–‹å‡º â†’ è¨˜éŒ„ â†’ **ç«‹å³æª¢æŸ¥è§¸ç™¼** â†’ **ç«‹å³é¡¯ç¤ºçµæœå±€** âœ…
T3: æª¢æ¸¬åˆ°å¯ä¸‹æ³¨ â†’ åŸ·è¡Œä¸‹æ³¨
T4: æ»‘é¼ ç§»å‹•å®Œæˆ
```

### ç‚ºä»€éº¼æ›´ç›´è§€ï¼Ÿ

1. **å³æ™‚åé¥‹**
   - ç”¨æˆ¶çœ‹åˆ°ç¬¬2å€‹Pé–‹å‡º
   - ç³»çµ±ç«‹å³é¡¯ç¤ºã€Œç­–ç•¥å·²è§¸ç™¼ï¼Œæº–å‚™ä¸‹æ³¨ã€
   - ç¬¦åˆå¿ƒç†é æœŸ

2. **æ¸…æ™°çš„å› æœé—œä¿‚**
   - çœ‹åˆ°çµæœ â†’ çœ‹åˆ°è§¸ç™¼
   - ä¸æ˜¯ã€Œçœ‹åˆ°çµæœ â†’ ç­‰å¾… â†’ çœ‹åˆ°æ»‘é¼ å‹• â†’ æ‰çŸ¥é“è§¸ç™¼ã€

3. **ç‹€æ…‹é€æ˜**
   - ç”¨æˆ¶çŸ¥é“ç³»çµ±å·²è­˜åˆ¥æ¨¡å¼
   - è€Œä¸æ˜¯ã€Œç³»çµ±åœ¨å¹¹å˜›ï¼Ÿç‚ºä»€éº¼é‚„æ²’åæ‡‰ï¼Ÿã€

---

## æ”¹æˆçµæœå‡ºä¾†å°±è§¸ç™¼çš„å½±éŸ¿åˆ†æ

### æ”¹å‹•æ–¹æ¡ˆ

#### æ–¹æ¡ˆ A: åœ¨ handle_result å¾Œç«‹å³æª¢æŸ¥è§¸ç™¼
```python
# engine_worker.py Line 494
def _handle_event(event):
    if event_type == "RESULT":
        # 1. æ›´æ–°æ­·å²
        self._line_orchestrator.handle_result(table_id, round_id, winner, timestamp)

        # 2. âœ… ç«‹å³æª¢æŸ¥æ˜¯å¦æœ‰ç­–ç•¥è§¸ç™¼ï¼ˆåƒ…ç”¨æ–¼ UI é¡¯ç¤ºï¼‰
        triggered_strategies = self._check_triggered_strategies(table_id, timestamp)

        # 3. âœ… å¦‚æœæœ‰è§¸ç™¼ï¼Œç«‹å³ç™¼é€ä¿¡è™Ÿé¡¯ç¤ºçµæœå±€
        if triggered_strategies:
            self._emit_trigger_signal(triggered_strategies)
```

#### æ–¹æ¡ˆ B: åœ¨ SignalTracker.record å¾Œè‡ªå‹•æª¢æŸ¥
```python
# signal.py Line 29
def record(self, table_id, round_id, winner, ts):
    ts = ts or time.time()
    deque = self.history[table_id]
    deque.append((winner, ts))

    # âœ… ç«‹å³æª¢æŸ¥æ˜¯å¦è§¸ç™¼
    if self.should_trigger(table_id, round_id, ts):
        return True  # è¿”å›è§¸ç™¼ç‹€æ…‹
    return False
```

---

### æ½›åœ¨å•é¡Œåˆ†æ

#### âŒ å•é¡Œ 1: round_id ä¸ä¸€è‡´
**ç—‡ç‹€ï¼š**
- T2 çµæœæª¢æ¸¬å‰µå»º round-T2
- T3 å¯ä¸‹æ³¨æª¢æ¸¬å‰µå»º round-T3ï¼ˆæ–°å±€ï¼‰
- å¦‚æœ T2 å°±é¡¯ç¤ºçµæœå±€ï¼Œç”¨çš„æ˜¯ round-T2
- ä½†å¯¦éš›ä¸‹æ³¨æ™‚ç”¨çš„æ˜¯ round-T3
- å¯èƒ½å°è‡´çµç®—æ™‚æ‰¾ä¸åˆ°å°æ‡‰çš„å€‰ä½

**åš´é‡ç¨‹åº¦ï¼š** ğŸ”´ é«˜

**è§£æ±ºæ–¹æ¡ˆï¼š**
- ä½¿ç”¨ã€Œé è§¸ç™¼ã€æ¦‚å¿µï¼šT2 é¡¯ç¤ºã€Œå³å°‡è§¸ç™¼ã€ï¼Œä½†ä¸å‰µå»ºå€‰ä½
- å¯¦éš›ä¸‹æ³¨ä»åœ¨ T3 é€²è¡Œï¼Œä½¿ç”¨æ­£ç¢ºçš„ round_id

#### âŒ å•é¡Œ 2: é‡è¤‡è§¸ç™¼æª¢æŸ¥
**ç—‡ç‹€ï¼š**
- T2: handle_result â†’ æª¢æŸ¥è§¸ç™¼ï¼ˆçµæœï¼šè§¸ç™¼ï¼‰
- T3: on_bettable_detected â†’ æª¢æŸ¥è§¸ç™¼ï¼ˆçµæœï¼šè§¸ç™¼ï¼‰
- å¯èƒ½é€ æˆé‡è¤‡é¡¯ç¤ºæˆ–é‡è¤‡ä¸‹æ³¨

**åš´é‡ç¨‹åº¦ï¼š** ğŸŸ¡ ä¸­

**è§£æ±ºæ–¹æ¡ˆï¼š**
- å»é‡æ©Ÿåˆ¶å·²å­˜åœ¨ï¼ˆDedupMode.OVERLAPï¼‰
- ä½†éœ€è¦ç¢ºä¿ UI ä¹Ÿä¸é‡è¤‡é¡¯ç¤º

#### âŒ å•é¡Œ 3: ç‹€æ…‹ä¸ä¸€è‡´
**ç—‡ç‹€ï¼š**
- T2: é¡¯ç¤ºçµæœå±€ï¼ˆphase = ARMEDï¼‰
- T3: å¯¦éš›ä¸‹æ³¨ï¼ˆphase = WAITING_RESULTï¼‰
- å¦‚æœ T3 æ²’æœ‰æª¢æ¸¬åˆ°å¯ä¸‹æ³¨ï¼Œçµæœå±€æœƒä¸€ç›´é¡¯ç¤º

**åš´é‡ç¨‹åº¦ï¼š** ğŸŸ¡ ä¸­

**è§£æ±ºæ–¹æ¡ˆï¼š**
- çµæœå±€æœ‰è¶…æ™‚æ©Ÿåˆ¶ï¼ˆ3ç§’å¾Œéš±è—ï¼‰
- æˆ–åœ¨ T3 ç¢ºèªä¸‹æ³¨å¾Œæ‰å¾ ARMED â†’ ENTERED

#### âœ… å•é¡Œ 4: æ€§èƒ½å½±éŸ¿
**ç—‡ç‹€ï¼š**
- æ¯æ¬¡çµæœéƒ½è¦æª¢æŸ¥æ‰€æœ‰ç­–ç•¥çš„è§¸ç™¼æ¢ä»¶

**åš´é‡ç¨‹åº¦ï¼š** ğŸŸ¢ ä½

**ç†ç”±ï¼š**
- should_trigger å¾ˆè¼•é‡ï¼ˆåªæª¢æŸ¥æœ€è¿‘å¹¾å€‹çµæœï¼‰
- ç­–ç•¥æ•¸é‡æœ‰é™ï¼ˆé€šå¸¸ < 10ï¼‰
- æ€§èƒ½å½±éŸ¿å¯å¿½ç•¥

#### âœ… å•é¡Œ 5: é‚è¼¯è¤‡é›œåº¦
**ç—‡ç‹€ï¼š**
- è§¸ç™¼æª¢æŸ¥é‚è¼¯å‡ºç¾åœ¨å…©å€‹åœ°æ–¹

**åš´é‡ç¨‹åº¦ï¼š** ğŸŸ¢ ä½

**ç†ç”±ï¼š**
- ç”¨é€”ä¸åŒï¼šT2 æ˜¯ã€Œé å‘Šã€ï¼ŒT3 æ˜¯ã€ŒåŸ·è¡Œã€
- å¯ä»¥é€šéæ¸…æ™°çš„å‘½åå€åˆ†

---

## çµè«–

### æœƒæœ‰å¾ˆå¤šåœ°æ–¹å‡ºå•é¡Œå—ï¼Ÿ

**ç­”æ¡ˆï¼šä¸æœƒï¼Œä½†éœ€è¦è¬¹æ…è™•ç† round_id ä¸€è‡´æ€§**

### é—œéµé¢¨éšª

| å•é¡Œ | åš´é‡æ€§ | è§£æ±ºé›£åº¦ | å»ºè­°æ–¹æ¡ˆ |
|------|-------|---------|---------|
| round_id ä¸ä¸€è‡´ | ğŸ”´ é«˜ | ä¸­ | ä½¿ç”¨ã€Œé è§¸ç™¼ã€UI ç‹€æ…‹ |
| é‡è¤‡è§¸ç™¼æª¢æŸ¥ | ğŸŸ¡ ä¸­ | ä½ | ä¾è³´ç¾æœ‰å»é‡æ©Ÿåˆ¶ |
| ç‹€æ…‹ä¸ä¸€è‡´ | ğŸŸ¡ ä¸­ | ä½ | UI è¶…æ™‚ + ç‹€æ…‹åŒæ­¥ |
| æ€§èƒ½å½±éŸ¿ | ğŸŸ¢ ä½ | - | ç„¡éœ€è™•ç† |
| é‚è¼¯è¤‡é›œåº¦ | ğŸŸ¢ ä½ | - | æ¸…æ™°å‘½å |

### å»ºè­°å¯¦ç¾æ–¹å¼

**æ¨è–¦ï¼šæ–¹æ¡ˆ A +ã€Œé è§¸ç™¼ã€ç‹€æ…‹**

1. **T2 çµæœæª¢æ¸¬å¾Œï¼š**
   - æª¢æŸ¥ should_trigger()
   - å¦‚æœè§¸ç™¼ â†’ ç™¼é€ `strategy_pre_triggered` ä¿¡è™Ÿ
   - UI é¡¯ç¤ºã€Œç­–ç•¥å·²è§¸ç™¼ï¼Œç­‰å¾…ä¸‹æ³¨æ™‚æ©Ÿã€ï¼ˆä¸å‰µå»ºå€‰ä½ï¼‰

2. **T3 å¯ä¸‹æ³¨æª¢æ¸¬æ™‚ï¼š**
   - æ­£å¸¸åŸ·è¡Œç¾æœ‰é‚è¼¯
   - ç”Ÿæˆæ±ºç­– â†’ å‰µå»ºå€‰ä½ â†’ ä¸‹æ³¨
   - UI å¾ã€Œé è§¸ç™¼ã€â†’ã€Œå·²ä¸‹æ³¨ã€

3. **å¥½è™•ï¼š**
   - âœ… ç”¨æˆ¶ç«‹å³çœ‹åˆ°è§¸ç™¼ï¼ˆç¬¦åˆç›´è¦ºï¼‰
   - âœ… round_id ä¸€è‡´æ€§ï¼ˆå€‰ä½åœ¨ T3 å‰µå»ºï¼‰
   - âœ… ä¸ç ´å£ç¾æœ‰é‚è¼¯
   - âœ… åƒ…å¢åŠ  UI é¡¯ç¤ºå±¤çš„æå‰é€šçŸ¥

---

## ä¸‹ä¸€æ­¥

1. å¯¦ç¾ã€Œé è§¸ç™¼ã€æª¢æŸ¥é‚è¼¯
2. æ–°å¢ `strategy_pre_triggered` ä¿¡è™Ÿ
3. UI æ”¯æŒã€Œé è§¸ç™¼ã€ç‹€æ…‹é¡¯ç¤º
4. æ¸¬è©¦ round_id ä¸€è‡´æ€§
5. æ¸¬è©¦å»é‡æ©Ÿåˆ¶
